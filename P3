---
title: "TRABAJO FINAL TAPI"
author: "Ángel Martín-Lagos"
date: "2024-01-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Librerías

```{r}
library(haven)
library(dplyr)
library(tidyverse)
```


## Apertura de la base de datos
```{r}
qog <- read_dta("qog_std_ts_jan23_stata14.dta")
qog_simple <- readRDS("qog_simple.rds")
```


## Limpieza de variables

Una vez abierto el archivo, procedemos a limpiar las variables que emplearemos en nuestro estudio.

-   **paises_prop**

Comenzamos, en primer lugar, por la variable *paises_prop*. La convertiremos en variable dicotómica que tome los siguientes valores:

-   1 -> cuando el país efectivamente tenga un sistema electoral proporcional.
-   2 -> cuando el país tenga un sistema electoral de otro tipo.

La creamos de la siguiente manera:

```{r}
qog <- qog |> 
  mutate(paises_prop = case_when(iaep_es == 1 ~ 0,
                                 iaep_es == 3 ~ 1,
                                 T ~ 0)) |> 
  mutate(paises_prop = fct_recode(as_factor(paises_prop),
                                  "Otros sistemas" = "0",
                                  "Sistema proporcional" = "1"))
table(qog$paises_prop)
```

-   **aprob_const**

Esta variable la convertiremos así mismo en variable dicotómica tomando los siguientes valores:

-   1 -> si la aprobación de la constitución se produjo desde la tercera ola democratizadora (1974) hasta la actualidad
-   0 -> si la constitución se aprobó antes de 1974.

```{r}
qog <- qog |> 
  mutate(aprob_const = if_else(iaep_const >= 49, 1, 0)) |> 
  mutate(aprob_const = fct_recode(as_factor(aprob_const),
                                  "Antes de 1974" = "0",
                                  "Después de 1974" = "1"))
table(qog$aprob_const)
```

-   **PIB**

Simplemente renombramos la variable gle_cgdpc. Esta variable continua muestra el GDP per cápita según los precios actuales

```{r}
qog <- qog |> 
  rename(pib = gle_cgdpc)
```

-   **Gini**

Al igual que con la variable anterior, únicamente renombramos la variable wdi_gini por gini.

En ella, 0 representa una igualdad perfecta, mientras que un índice de 100 implica absoluta desigualdad.

```{r}
qog <- qog |> 
  rename(gini = wdi_gini)
```
- **fr_etnica**

Renombramos la variable al_ethnic2000 a fr_etnica. Esta variable continua refiere a la medida de la diversidad/heterogeneidad étnica dentro de una población. Cuanto mayor sea la fraccionalización étnica más diversa será la composición étnica de la población.

El índice de probabilidad varía de 0 a 1, donde:

-   un valor de 0 indica ninguna diversidad étnica (homogeneidad)

-   un valor de 1 indica la máxima diversidad étnica (heterogeneidad)

```{r}

qog <- qog %>% 
  rename(fr_etnica = al_ethnic2000)

```

- **fr_linguistica**

Al igual que la variable previa, la fraccionalización linguística refiere a la medida de diveresidad linguística dentro de una población. Cuanto mayor sea la fraccionalización linguística más diversa será la composición linguística de la población.

El índice de probabilidad varía de 0 a 1, donde:

-   un valor de 0 indica ninguna diversidad linguística (homogeneidad)

-   un valor de 1 indica la máxima diversidad linguística (heterogeneidad)

```{r}
qog <- qog %>% 
  rename(fr_linguistica = al_language2000)
```

- **fr_religion**

La fraccionalización religiosa es una variable continua que mide la diversidad en las afiliaciones religiosas en una población. Cuanto mayor sea el vlaor del índice fraccionalización religiosa, más diversa o fraccionada será la sociedad en términos de composición religiosa.

El índice de probabilidad varía de 0 a 1, donde:

-   un valor de 0 indica ninguna diversidad religiosa

-   un valor de 1 indica la máxima diversidad religiosa

```{r}
qog <- qog %>% 
  rename(fr_religion = al_religion2000)
```

- **pv_sd**

Renombramos la variable cpds_vs. Esta variable continua refiere a la participación de votos de los partidos políticos clasificados como socialdemócratas.

```{r}
qog <- qog %>% 
  rename(pv_sd = cpds_vs)
```

- **nivel_conf**

Renombramos y convertimos la variable en una dicotómica. Esta variable mide el nivel de intensidad de los conflictos sociales, étnicos y religiosos tomando los siguientes valores:

- 1 -> nivel de conflictividad bajo
- 2 -> nivel de conflictividad medio
- 3 -> nivel de conflicto alto


```{r}
qog <- qog %>% 
  mutate(nivel_conf = as_factor(bti_ci)) %>% 
  mutate(nivel_conf = fct_collapse(nivel_conf,
                      "1" = 1:3,
                      "2" = 4:6,
                      "3" = 7:10)) %>% 
  mutate(as.numeric(nivel_conf))

```

## Reducción del dataset

Voy a crear un dataset únicamente con las variables que vamos a emplear para el análisis de regresión. Para tener una sola observación país filtramos por el año más cercano al presente del que se dispongan datos sobre las variables que nos interesan

```{r}
myvars <- c("aprob_const", "paises_prop","pib", "gini", "cname", "year", "fr_etnico", "fr_linguistica", "fr_religion", "pv_sd", "nivel_conf") #Hay que incluir todas las variables que vamos a utilizar una vez que las tengamos limpias
qog_red <- qog[myvars]
qog_red <- na.omit(qog_red)
qog_red <- qog_red |> 
  group_by(cname) |> 
  slice_max(order_by = year) |> 
  ungroup()
```

